const infoArea00=document.getElementById("info-area00"),infoArea01=document.getElementById("info-area01"),infoArea02=document.getElementById("info-area02"),infoLost=document.getElementById("info-lost"),infoNotFound=document.getElementById("info-notfound"),cautionArea=document.getElementById("caution-area"),container=document.getElementById("container"),frmRegist=document.getElementById("frm-regist"),URL_API="https://script.google.com/macros/s/AKfycbyVtPa9o1sbeRkbBjiU4HNP98h9RvO8nsDRouD8l87Qz851en8isAlxSiyv7NvwwiHGBA/exec?channel=web",TTLStore=(()=>{function i(i,r,u){const f={value:r,expiresAt:u?t()+u:null,savedAt:t(),v:1};localStorage.setItem(n+i,JSON.stringify(f))}function r(i){const r=localStorage.getItem(n+i);if(!r)return null;try{const u=JSON.parse(r);return u.expiresAt&&t()>u.expiresAt?(localStorage.removeItem(n+i),null):u.value}catch(u){return localStorage.removeItem(n+i),null}}function u(t){localStorage.removeItem(n+t)}function f(){const i=n;for(let n=0;n<localStorage.length;n++){const r=localStorage.key(n);if(r&&r.startsWith(i))try{const n=JSON.parse(localStorage.getItem(r));n&&n.expiresAt&&t()>n.expiresAt&&localStorage.removeItem(r)}catch(u){localStorage.removeItem(r)}}}const n="app:parkingpermit:",t=()=>Date.now();return{set:i,get:r,remove:u,sweep:f}})(),renderInfo=(n,t="",i="",r="",u=undefined)=>{if(t.toString().trim()=="")return"";let f=t;return u=="a"&&(f=`<a href="tel:${t.replace(/\D/g,"")}">${t}</a>`),`<div class="item ${i}">
            <div class="label">${n}</div>
            <div class="value ${r}">${f}</div>
            </div>`},showError=(n="")=>{infoArea00.innerHTML=n==""?"":`<div class="error">${n}</div>`,container.classList.remove("loader")},showLost=n=>{infoLost.innerHTML=infoLost.innerHTML+`
    <br> สติกเกอร์หมายเลข ${n["label-no"]}
    <br> วันที่แจ้งหาย ${new Date(n["datetime-update"]).toLocaleDateString("th-TH",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}
    `,container.classList.add("lost"),container.classList.remove("loader")},showNotFound=()=>{showError(),container.classList.add("notfound"),container.classList.remove("loader")},_scorllTop=()=>{window.scrollTo({top:0,behavior:"smooth"})},getParamFromURL=n=>{const t=new URLSearchParams(window.location.search);return t.get(n)},_getLocation=()=>new Promise((n,t)=>{navigator.geolocation.getCurrentPosition(n,t)}),render_form=n=>{infoArea00.innerHTML="";infoArea01.innerHTML="";infoArea02.innerHTML="";document.getElementById("frm-regist").querySelector("#vehicle-type").addEventListener("change",function(){let t=this.value,n=document.getElementById("frm-regist");n.classList.remove("vehicle-type-");n.classList.remove("vehicle-type-car");n.classList.remove("vehicle-type-bike");n.classList.add("vehicle-type-"+t.toLowerCase())});document.getElementById("frm-regist").getElementsByTagName("form")[0].addEventListener("submit",async function(n){n.preventDefault();showError("...กำลังบันทึกรายการ โปรดรอ...");document.getElementById("label-no").disabled=!1;document.getElementById("vehicle-type").disabled=!1;const i=n.target,r=new FormData(i);let t=r.entries();for(let[n,i]of t){const r=n.match(/^vehicles\[(\d+)\]\[(.+)\]$/);if(r){const n=parseInt(r[1],10),u=r[2];t.vehicles||(t.vehicles=[]);t.vehicles[n]||(t.vehicles[n]={});t.vehicles[n][u]=i}else t[n]=i}pushDataRegist(t)});document.getElementById("label-no").value=n["label-no"]||"";document.getElementById("vehicle-type").value=n["vehicle-type"]||"";document.getElementById("vehicle-type").dispatchEvent(new Event("change"));document.getElementsByClassName("permit-qr").item(0).value=getParamFromURL("c");document.getElementsByClassName("permit-qr").item(1).value=getParamFromURL("c");document.getElementById("vehicle-type").required=!0;document.getElementById("label-no").required=!0;let t=n["label-no"]!=""&&n["vehicle-type"]!="";document.getElementById("label-no").disabled=t;document.getElementById("vehicle-type").disabled=t;document.getElementById("lp-no-0").required=t;document.getElementById("lp-province-0").required=t;document.getElementById("owner-unit").required=t;document.getElementById("owner-unit").value=n["owner-unit"]||"";document.getElementById("owner-name").required=t;document.getElementById("owner-name").value=n["owner-name"]||"";document.getElementById("owner-phone").required=t;document.getElementById("owner-phone").value=n["owner-phone"]||"";frmRegist.style.display="block";container.classList.remove("loader")},render_info=(n,t=false)=>{var i,r;frmRegist.style.display="none";cautionArea.style.display="none";i=n;infoArea01.innerHTML=`
        <h1>ข้อมูลผู้ใช้สิทธิ์จอดยานพาหนะ</h1>
        ${renderInfo("รหัสคิวอาร์",i["permit-qr"])}
        ${renderInfo("ลำดับสติกเกอร์",i["label-no"])}
        ${n.vehicles.length?"":renderInfo("ประเภท",i["vehicle-type"]=="BIKE"?"จักรยานยนต์":"รถยนต์")}
        ${renderInfo("อาคาร/โซนจอดฯ",function(n){return{BLD_A:"อาคาร A",BLD_B:"อาคาร B",BLD_C:"อาคาร C"}[n]}(i["owner-zone"]))}
        ${renderInfo("เลขที่ห้องชุด",i["owner-unit"])}
        ${renderInfo("ชื่อเจ้าของร่วมฯ",i["owner-name"])}
        ${renderInfo("หมายเลขโทรศัพท์",i["owner-phone"],"","phone","a")}

        ${n["is-regist"]?renderInfo("วันลงทะเบียน",new Date(i["datetime-regist"]).toLocaleDateString("th-TH",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),"",""):""}

        ${n["is-regist"]?renderInfo("วันหมดอายุ",new Date(i["date-expire"]).toLocaleDateString("th-TH",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),"","expired"):""}

        ${renderInfo("หมายเหตุ",i.remark,"remark")}

        ${t?"":`<button onclick="fetchDataPrivate()">รายละเอียดผู้ใช้สิทธิ์ฯเพิ่มเติม</button>`}
    `;infoArea02.innerHTML="";r="";n.vehicles.forEach(function(n,t){r+=`
        <h2>ยานพาหนะ #${t+1} </h2>
        ${renderInfo("ประเภท",n["vehicle-type"]=="BIKE"?"จักรยานยนต์":"รถยนต์","vehicle-type-"+(n["vehicle-type"]=="BIKE"?"bike":"car")+(t+1))}
        ${renderInfo("เลขทะเบียน",n["lp-no"])}
        ${renderInfo("จังหวัดจดทะเบียน",n["lp-province"])}
        `});infoArea02.innerHTML=r!=""?r:"<h2>ไม่พบข้อมูลยานพาหนะที่ลงทะเบียน<\/h2>";cautionArea.style.display="block";showError()},fetchIPAddr=async()=>{const t=await fetch("https://api.ipify.org?format=json"),n=await t.json();return n.ip?n.ip:undefined},fetchDataPublic=async n=>{try{if(container.classList.contains("loader"))return 0;container.classList.remove("lost");showError("<h1>... กำลังค้นหา ...<\/h1>");infoArea01.innerHTML="";infoArea02.innerHTML="";container.classList.add("loader");_scorllTop();let i=await fetchIPAddr();const r=await fetch(`${URL_API}`,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({"user-agent":navigator.userAgent,"ip-addr":i,action:"permit-public","permit-qr":n})}),t=await r.json();if(!t){showError("...เกิดข้อผิดพลาดในการดึงข้อมูล...");return}if(t&&t.status=="fail"){showNotFound();return}if(t&&t.status=="",!t.data){showNotFound();return}if(t.data["is-lost"])return showError(""),showLost(t.data),0;if(!t.data["is-regist"])return render_form(t.data),0;render_info(t.data);container.classList.remove("loader")}catch(t){container.classList.remove("loader");showError("...เกิดข้อผิดพลาดในการดึงข้อมูล...")}},fetchDataPrivate=async n=>{try{if(container.classList.contains("loader"))return 0;const i=getParamFromURL("c");if(n=n?n:prompt("กรุณากรอกรหัสผ่าน:"),n==""||!n)return 0;_scorllTop();infoArea01.innerHTML==""?showError("<h1>... กำลังค้นหา ...<\/h1>"):showError("...กำลังเข้าถึงข้อมูล...");container.classList.add("loader");let r=await fetchIPAddr();const u=await fetch(`${URL_API}`,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({"user-agent":navigator.userAgent,"ip-addr":r,action:"permit-private","permit-qr":i,"user-key":n})}),t=await u.json();if(!t){showError("...เกิดข้อผิดพลาดในการดึงข้อมูล...");return}if(t&&t.status=="fail"){showError("... ไม่อนุญาติให้เข้าถึง/รหัสผ่านผิด ...");return}if(!t.data){showNotFound();return}if(!t.data["is-regist"])return render_form(t.data),0;if(t.data["is-lost"])return showError(""),showLost(t.data),0;showError("");render_info(t.data,!0);TTLStore.get("key")?"":TTLStore.set("key",n,72e5)}catch(t){showError("...เกิดข้อผิดพลาดในการดึงข้อมูล...")}},pushDataRegist=async n=>{try{container.classList.add("loader");_scorllTop();let i=n;i.action="permit-regist";i["ip-addr"]=await fetchIPAddr();i["user-agent"]=navigator.userAgent;const r=await fetch(`${URL_API}`,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(i)}),t=await r.json();if(t&&t.status=="fail"){infoArea01.innerHTML="";showError("...บันทึกข้อมูลไม่สำเร็จ...");return}if(t&&t.status=="not-found"){infoArea01.innerHTML="";showError(`...${t.message}...`);return}if(t&&t.status=="conflict"){infoArea01.innerHTML="";showError(`...${t.message}...`);return}showError("...ลงทะเบียนสำเร็จ...");render_info(t.data,!0);container.classList.remove("loader")}catch(t){container.classList.remove("loader");showError("...เกิดข้อผิดพลาด กรุณาบันทึกใหม่อีกครั้ง...")}},code=getParamFromURL("c");if(code){let n=TTLStore.get("key")||undefined;n?fetchDataPrivate(n):fetchDataPublic(code)}else showError("ไม่พบรหัสคิวอาร์ในเส้นทาง");